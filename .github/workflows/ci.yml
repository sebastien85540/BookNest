name: Laravel CI/CD

on:
  push:
    branches:
      - dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Cloner le repo
        uses: actions/checkout@v4

      - name: ðŸ”¨ Construire les conteneurs
        run: docker compose up -d --build

      - name: ðŸš€ VÃ©rifier que MySQL est prÃªt
        run: |
          sleep 10
          docker compose exec -T db mysqladmin ping -h db -uroot -proot

      - name: ðŸ“¦ Installer les dÃ©pendances Composer
        run: docker compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: ðŸ”„ Lancer les migrations
        run: docker compose exec -T app php artisan migrate --force

      - name: âœ… Lancer les tests Laravel
        run: docker compose exec -T app php artisan test

  deploy:
    needs: build-and-test
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Cloner le repo
        uses: actions/checkout@v4

      - name: ðŸš€ Fusionner `dev` dans `main`
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git fetch origin main
          git checkout main
          git merge dev --no-ff --allow-unrelated-histories         
          git push origin main

          #      - name: ðŸ“¤ DÃ©ploiement sur le serveur
        #        run: |
          #          ssh user@your-server "cd /path/to/laravel && git pull origin main && docker compose up -d --build"

