name: CI/CD Laravel

on:
  push:
    branches:
      - dev  # DÃ©clenchement sur dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v3

      - name: ğŸ³ DÃ©marrage des services avec Docker Compose
        run: |
          docker compose down --volumes --remove-orphans 
          docker compose up -d
          sleep 10

      - name: ğŸ” VÃ©rification des logs des services
        run: docker compose logs

      - name: VÃ©rification des conteneurs en cours d'exÃ©cution
        run: docker ps -a

      - name: ğŸ• Attente du dÃ©marrage des services
        run: sleep 15s  # Attendre que MySQL et Laravel dÃ©marrent

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: docker compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: ğŸ”‘ GÃ©nÃ©ration de la clÃ© d'application Laravel
        run: docker compose exec -T app php artisan key:generate

      - name: ğŸ—ï¸ ExÃ©cution des migrations
        run: docker compose exec -T app php artisan migrate --force

      - name: âœ… ExÃ©cution des tests Laravel
        run: docker compose exec -T app php artisan test

          #  merge-and-deploy:
          #    needs: build-and-test
          #    runs-on: ubuntu-latest
          #    if: success()

          #    steps:
          #      - name: ğŸ“¥ Checkout du code
          #        uses: actions/checkout@v3

          #      - name: ğŸ”„ Fusion de dev vers main
          #        run: |
          #          git config --global user.name "github-actions[bot]"
          #          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          #          git checkout main
          #          git merge dev --no-ff --allow-unrelated-histories -m "Auto-merge dev into main"
          #          git push origin main

          #      - name: ğŸš€ DÃ©ploiement sur le serveur
          #        run: |
          #          ssh user@server "cd /chemin/projet && git pull origin main && docker-compose up -d --build"

