name: CI/CD Laravel

on:
  push:
    branches:
      - dev  # Déclenchement sur dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Récupération du code
        uses: actions/checkout@v3

      - name: 🐳 Démarrage des services avec Docker Compose
        run: |
          docker compose down --volumes --remove-orphans 
          docker compose up -d
          sleep 10

      - name: 🔍 Vérification des logs des services
        run: docker compose logs

      - name: Vérification des conteneurs en cours d'exécution
        run: docker ps -a

      - name: 🕐 Attente du démarrage des services
        run: sleep 15s  # Attendre que MySQL et Laravel démarrent

      - name: 📦 Installation des dépendances
        run: docker compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: 🔑 Génération de la clé d'application Laravel
        run: docker compose exec -T app php artisan key:generate

      - name: 🏗️ Exécution des migrations
        run: docker compose exec -T app php artisan migrate --force

      - name: ✅ Exécution des tests Laravel
        run: docker compose exec -T app php artisan test

          #  merge-and-deploy:
          #    needs: build-and-test
          #    runs-on: ubuntu-latest
          #    if: success()

          #    steps:
          #      - name: 📥 Checkout du code
          #        uses: actions/checkout@v3

          #      - name: 🔄 Fusion de dev vers main
          #        run: |
          #          git config --global user.name "github-actions[bot]"
          #          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          #          git checkout main
          #          git merge dev --no-ff --allow-unrelated-histories -m "Auto-merge dev into main"
          #          git push origin main

          #      - name: 🚀 Déploiement sur le serveur
          #        run: |
          #          ssh user@server "cd /chemin/projet && git pull origin main && docker-compose up -d --build"

