name: CI/CD Pipeline

on:
  push:
    branches:
      - dev  # D√©clenchement lorsque la branche `dev` est mise √† jour

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: dev  # On s'assure de r√©cup√©rer la branche dev

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'  # ou la version de PHP que tu utilises

    - name: Install dependencies
      run: |
        composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: Set up Docker Compose
      run: |
        docker-compose -f docker-compose.yml up -d --build

    - name: Run tests
      run: |
        docker-compose exec -T app vendor/bin/phpunit  # Ex√©cuter les tests Laravel

    - name: Merge dev into main
      run: |
        git fetch origin main
        git checkout main
        git merge dev --no-ff --allow-unrelated-histories --strategy=recursive -X theirs

    - name: Push changes to main
      run: |
        git push https://github.com/sebastien85540/BookNest.git HEAD:main
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # Token d'acc√®s personnel que tu as ajout√© dans les secrets

#      - name: üì§ D√©ploiement sur le serveur
        #        run: |
          #          ssh user@your-server "cd /path/to/laravel && git pull origin main && docker compose up -d --build"

